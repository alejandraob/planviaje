# üöÄ Instrucciones de Setup - Backend Plan Viaje

## üìã Requisitos Previos

Antes de comenzar, aseg√∫rate de tener instalado:

- **Node.js** v18 o superior ([Descargar aqu√≠](https://nodejs.org/))
- **PostgreSQL** 14 o superior ([Descargar aqu√≠](https://www.postgresql.org/download/))
- **npm** (viene con Node.js)
- **Git** (opcional, para clonar el repo)

Verifica las instalaciones:
```bash
node --version    # Debe mostrar v18.x.x o superior
npm --version     # Debe mostrar 8.x.x o superior
psql --version    # Debe mostrar PostgreSQL 14.x o superior
```

---

## üóÑÔ∏è Configuraci√≥n de la Base de Datos

### Paso 1: Crear la base de datos

Abre una terminal y ejecuta PostgreSQL:

**En Windows:**
```bash
psql -U postgres
```

**En Mac/Linux:**
```bash
sudo -u postgres psql
```

Una vez dentro de PostgreSQL, ejecuta:
```sql
-- Crear la base de datos de desarrollo
CREATE DATABASE plan_viaje_dev;

-- Verificar que se cre√≥
\l

-- Salir de PostgreSQL
\q
```

### Paso 2: Configurar credenciales

**IMPORTANTE:** El archivo `.env` debe estar en la ra√≠z del proyecto backend.

Si no existe el archivo `.env`, cr√©alo con este contenido:

```env
# Base de Datos PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_NAME=plan_viaje_dev
DB_USER=postgres
DB_PASSWORD=tu_password_aqui

# Puerto del servidor
PORT=3001

# JWT Secrets (puedes usar cualquier string largo y aleatorio)
JWT_SECRET=tu_jwt_secret_super_seguro_aqui_123456789
JWT_REFRESH_SECRET=tu_jwt_refresh_secret_super_seguro_aqui_987654321

# Ambiente
NODE_ENV=development

# Firebase (opcional para dev, usa dev-login en su lugar)
# FIREBASE_PROJECT_ID=tu-proyecto
# FIREBASE_PRIVATE_KEY=tu-private-key
# FIREBASE_CLIENT_EMAIL=tu-email
```

**üîê Importante sobre las credenciales:**
- Reemplaza `tu_password_aqui` con tu contrase√±a de PostgreSQL
- Los JWT_SECRET pueden ser cualquier string largo (m√≠nimo 32 caracteres)
- Para desarrollo, NO necesitas configurar Firebase (usa `/api/auth/dev-login`)

### Paso 3: Verificar conexi√≥n a PostgreSQL

Prueba que puedes conectarte con las credenciales del `.env`:

```bash
psql -U postgres -d plan_viaje_dev
```

Si conecta correctamente, escribe `\q` para salir.

---

## üì¶ Instalaci√≥n de Dependencias

### Paso 1: Navegar al directorio backend

```bash
cd backend
```

### Paso 2: Instalar dependencias de Node

```bash
npm install
```

Esto instalar√° todas las dependencias listadas en `package.json`:
- express
- sequelize
- pg (PostgreSQL driver)
- jsonwebtoken
- bcryptjs
- joi
- winston
- cors
- helmet
- express-rate-limit
- dotenv
- y m√°s...

**Tiempo estimado:** 1-3 minutos

---

## üèóÔ∏è Inicializar las Tablas

Despu√©s de instalar las dependencias, necesitas crear todas las tablas en la base de datos.

### Opci√≥n 1: Reset completo (BORRA TODOS LOS DATOS)

```bash
npm run db:reset
```

**‚ö†Ô∏è ADVERTENCIA:** Este comando:
1. Elimina todas las tablas existentes
2. Crea todas las tablas desde cero
3. Borra todos los datos

√ösalo solo:
- En el primer setup
- Cuando quieras empezar de cero
- En desarrollo (nunca en producci√≥n)

### Opci√≥n 2: Sincronizar modelos (no borra datos)

```bash
npm run db:sync
```

Esto sincroniza los modelos con la base de datos sin borrar datos existentes.

### Verificar que las tablas se crearon

```bash
psql -U postgres -d plan_viaje_dev
```

Dentro de PostgreSQL:
```sql
-- Ver todas las tablas
\dt

-- Deber√≠as ver 19 tablas:
-- usuarios
-- viajes
-- miembros_viaje
-- cronograma
-- franjas
-- alojamientos
-- actividades
-- gastos
-- deudas
-- pagos              <- Nueva tabla
-- subgrupos
-- subgrupo_miembros
-- gasto_subgrupos
-- deuda_subgrupos
-- notificaciones
-- configuracion_viaje
-- tasas_cambio
-- auditoria
-- usuarios_firebase

-- Salir
\q
```

---

## üë§ Crear Usuario de Prueba

Para poder hacer login en desarrollo, necesitas al menos un usuario:

```bash
npm run create-test-user
```

Esto crea un usuario de prueba:
- **Email:** `test@example.com`
- **Password:** `test123`
- **Nombre:** Test User

Puedes crear m√°s usuarios manualmente ejecutando el script m√∫ltiples veces o modificando `src/scripts/createTestUser.js`.

---

## üöÄ Arrancar el Servidor

### Modo Desarrollo (con auto-reload)

```bash
npm run dev
```

**Caracter√≠sticas:**
- Auto-reinicio cuando cambias archivos
- Hot reload
- Logs detallados en consola

**Salida esperada:**
```
[info]: üî• Initializing Firebase Admin SDK...
[info]: ‚úÖ Firebase Admin SDK initialized successfully
[info]: üîç Testing database connection...
[info]: ‚úÖ Database connection established successfully
[info]: üìä Connected to: plan_viaje_dev on localhost:5432
[info]: üöÄ Server running in development mode
[info]: üì° Server listening on port 3001
[info]: üåê API URL: http://localhost:3001/api
[info]: üè† Frontend URL: http://localhost:5173
[info]: ‚úÖ Server started successfully
```

### Modo Producci√≥n

```bash
npm start
```

Usa este modo solo en servidores de producci√≥n.

### Detener el servidor

Presiona `Ctrl + C` en la terminal donde est√° corriendo.

---

## üß™ Verificar que Todo Funciona

### 1. Health Check

Abre tu navegador o usa curl:

```bash
curl http://localhost:3001/api/health
```

Respuesta esperada:
```json
{
  "success": true,
  "message": "API is running",
  "timestamp": "2025-10-22T..."
}
```

### 2. Login de Prueba

Prueba el endpoint de autenticaci√≥n:

**Usando curl:**
```bash
curl -X POST http://localhost:3001/api/auth/dev-login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```

**Usando archivo .http:** (con extensi√≥n REST Client en VS Code)

Abre `tests/viajes.http` y ejecuta la primera petici√≥n.

Respuesta esperada:
```json
{
  "success": true,
  "data": {
    "user": {
      "id_usuario": 1,
      "email": "test@example.com",
      "nombre": "Test",
      "apellido": "User"
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "..."
  }
}
```

### 3. Ejecutar Suite de Tests Automatizados

```bash
npm run test:api
```

**Resultado esperado:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         Plan Viaje Backend - Automated Testing             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Total Tests: 54
‚úÖ Passed: 54
‚ùå Failed: 0
Success Rate: 100.00%

‚úÖ All tests passed! üéâ
```

**‚ö†Ô∏è Nota:** Para que los tests pasen, el servidor debe estar corriendo.

---

## üìö Endpoints Disponibles

### Autenticaci√≥n
- `POST /api/auth/register` - Registrar usuario con Firebase
- `POST /api/auth/dev-login` - Login de desarrollo (SIN Firebase) ‚≠ê
- `GET /api/auth/me` - Usuario actual
- `POST /api/auth/refresh` - Refrescar token
- `POST /api/auth/logout` - Cerrar sesi√≥n

### Viajes
- `POST /api/viajes` - Crear viaje
- `GET /api/viajes` - Listar viajes
- `GET /api/viajes/:id` - Detalles
- `PUT /api/viajes/:id` - Actualizar
- `GET /api/viajes/:id/estadisticas` - Estad√≠sticas

### Miembros (anidado en viajes)
- `POST /api/viajes/:id/miembros` - Invitar miembro
- `GET /api/viajes/:id/miembros` - Listar miembros
- `GET /api/viajes/:id/miembros/:idMiembro` - Detalles
- `PUT /api/viajes/:id/miembros/:idMiembro` - Actualizar
- `DELETE /api/viajes/:id/miembros/:idMiembro` - Eliminar

### Franjas (anidado en viajes)
- `POST /api/viajes/:id/franjas` - Crear franja
- `GET /api/viajes/:id/franjas` - Listar
- `GET /api/viajes/:id/franjas/:idFranja` - Detalles
- `PUT /api/viajes/:id/franjas/:idFranja` - Actualizar
- `DELETE /api/viajes/:id/franjas/:idFranja` - Eliminar
- `PUT /api/viajes/:id/franjas/:idFranja/reordenar` - Reordenar
- `GET /api/viajes/:id/franjas/estadisticas` - Estad√≠sticas

### Alojamientos (anidado en viajes)
- 7 endpoints para gesti√≥n de alojamientos
- Ver documentaci√≥n: `API_ALOJAMIENTOS.md`

### Actividades (anidado en viajes)
- 7 endpoints para gesti√≥n de actividades
- Ver documentaci√≥n en el c√≥digo

### Gastos (anidado en viajes)
- 7 endpoints para gesti√≥n de gastos
- Filtros avanzados por categor√≠a, tipo, estado, pagador

### Deudas (anidado en viajes)
- 8 endpoints para gesti√≥n de deudas
- Incluye resumen de balance

### üÜï Pagos (anidado en deudas)
- 7 endpoints para gesti√≥n de pagos
- **Ver documentaci√≥n completa:** `API_PAGOS.md`
- Flujo: registrar ‚Üí confirmar ‚Üí auto-actualiza deuda

### üÜï Notificaciones
- 9 endpoints para notificaciones
- **Ver documentaci√≥n completa:** `API_NOTIFICACIONES.md`
- Env√≠o individual o difusi√≥n masiva

### Subgrupos (anidado en viajes)
- 7 endpoints para gesti√≥n de subgrupos
- Ver documentaci√≥n: `API_SUBGRUPOS.md`

**Total: 66 endpoints funcionales** ‚úÖ

---

## üîß Scripts NPM Disponibles

```bash
# Desarrollo
npm run dev              # Servidor con auto-reload (nodemon)

# Producci√≥n
npm start                # Servidor sin auto-reload

# Base de Datos
npm run db:reset         # ‚ö†Ô∏è BORRA TODO y recrea tablas
npm run db:sync          # Sincroniza modelos sin borrar datos

# Usuarios
npm run create-test-user # Crear usuario test@example.com

# Testing
npm run test:api         # Ejecutar tests automatizados (54 tests)
npm test                 # Tests unitarios (si los hay)
```

---

## üß∞ Herramientas Recomendadas

### 1. VS Code con Extensiones

**Extensiones √∫tiles:**
- **REST Client** - Para ejecutar archivos `.http`
  - Instalar: busca "REST Client" en VS Code
  - Usar: abre cualquier `.http` en `tests/` y click en "Send Request"

- **PostgreSQL** - Para explorar la base de datos

- **ESLint** - Para linting de c√≥digo

- **Prettier** - Para formato de c√≥digo

### 2. Postman (alternativa a REST Client)

Si prefieres Postman:
1. Importa los archivos `.http` como colecciones
2. Configura la variable `{{baseUrl}}` = `http://localhost:3001/api`
3. Configura la variable `{{token}}` con el token de login

### 3. pgAdmin (alternativa para PostgreSQL)

Interfaz gr√°fica para explorar y administrar PostgreSQL:
- [Descargar pgAdmin](https://www.pgadmin.org/download/)

---

## üêõ Soluci√≥n de Problemas Comunes

### ‚ùå Error: "connect ECONNREFUSED"

**Problema:** No se puede conectar a PostgreSQL

**Soluciones:**
1. Verifica que PostgreSQL est√© corriendo:
   ```bash
   # Windows
   sc query postgresql-x64-14

   # Mac
   brew services list

   # Linux
   sudo systemctl status postgresql
   ```

2. Verifica las credenciales en `.env`

3. Verifica que el puerto 5432 est√© libre:
   ```bash
   netstat -an | findstr 5432
   ```

### ‚ùå Error: "Port 3001 already in use"

**Problema:** El puerto 3001 ya est√° siendo usado

**Soluciones:**

**Windows:**
```bash
# Ver qu√© est√° usando el puerto
netstat -ano | findstr :3001

# Matar el proceso (reemplaza PID con el n√∫mero que viste)
taskkill /PID <PID> /F
```

**Mac/Linux:**
```bash
# Ver qu√© est√° usando el puerto
lsof -i :3001

# Matar el proceso
kill -9 <PID>
```

**O cambiar el puerto en `.env`:**
```env
PORT=3002
```

### ‚ùå Error: "JWT_SECRET is not defined"

**Problema:** Falta el archivo `.env` o est√° mal configurado

**Soluci√≥n:**
1. Verifica que el archivo `.env` existe en la ra√≠z de `backend/`
2. Copia el template de arriba
3. Reinicia el servidor

### ‚ùå Tests fallan con errores 404

**Problema:** El servidor no est√° corriendo o las rutas cambiaron

**Soluci√≥n:**
1. Aseg√∫rate de que el servidor est√© corriendo: `npm run dev`
2. Verifica que el servidor muestre "Server listening on port 3001"
3. Prueba el health check primero

### ‚ùå Error: "relation 'usuarios' does not exist"

**Problema:** Las tablas no se crearon en la base de datos

**Soluci√≥n:**
```bash
npm run db:reset
```

### ‚ùå Error: "password authentication failed"

**Problema:** Contrase√±a de PostgreSQL incorrecta en `.env`

**Soluci√≥n:**
1. Verifica la contrase√±a correcta de PostgreSQL
2. Actualiza `DB_PASSWORD` en `.env`
3. Reinicia el servidor

---

## üìÇ Estructura del Proyecto

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/              # Configuraciones (DB, Firebase)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/         # 11 controladores HTTP
‚îÇ   ‚îú‚îÄ‚îÄ middleware/          # Auth, validation, error handling
‚îÇ   ‚îú‚îÄ‚îÄ models/              # 19 modelos Sequelize
‚îÇ   ‚îú‚îÄ‚îÄ routes/              # 11 archivos de rutas
‚îÇ   ‚îú‚îÄ‚îÄ services/            # 11 servicios de l√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ utils/               # Utilidades (errors, validationSchemas)
‚îÇ   ‚îú‚îÄ‚îÄ scripts/             # Scripts auxiliares
‚îÇ   ‚îî‚îÄ‚îÄ app.js               # Configuraci√≥n de Express
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ viajes.http          # Tests manuales de Viajes
‚îÇ   ‚îú‚îÄ‚îÄ miembros.http        # Tests manuales de Miembros
‚îÇ   ‚îú‚îÄ‚îÄ franjas.http         # Tests manuales de Franjas
‚îÇ   ‚îú‚îÄ‚îÄ alojamientos.http    # Tests manuales de Alojamientos
‚îÇ   ‚îú‚îÄ‚îÄ actividades.http     # Tests manuales de Actividades
‚îÇ   ‚îú‚îÄ‚îÄ gastos.http          # Tests manuales de Gastos
‚îÇ   ‚îú‚îÄ‚îÄ deudas.http          # Tests manuales de Deudas
‚îÇ   ‚îú‚îÄ‚îÄ pagos.http           # Tests manuales de Pagos üÜï
‚îÇ   ‚îú‚îÄ‚îÄ notificaciones.http  # Tests manuales de Notificaciones üÜï
‚îÇ   ‚îú‚îÄ‚îÄ subgrupos.http       # Tests manuales de Subgrupos
‚îÇ   ‚îî‚îÄ‚îÄ run-tests.js         # Suite de tests automatizados
‚îú‚îÄ‚îÄ .env                     # Variables de entorno (NO commitear)
‚îú‚îÄ‚îÄ .env.example             # Template de .env
‚îú‚îÄ‚îÄ package.json             # Dependencias y scripts
‚îú‚îÄ‚îÄ server.js                # Entry point
‚îú‚îÄ‚îÄ API_*.md                 # Documentaci√≥n de APIs
‚îú‚îÄ‚îÄ PROGRESO_DESARROLLO.md   # Estado del desarrollo
‚îî‚îÄ‚îÄ SETUP_INSTRUCCIONES.md   # Este archivo

```

---

## üéØ Flujo Completo de Primer Uso

**Resumen paso a paso:**

```bash
# 1. Instalar PostgreSQL y Node.js (ver requisitos previos)

# 2. Crear base de datos
psql -U postgres
CREATE DATABASE plan_viaje_dev;
\q

# 3. Configurar .env (copiar template y editar credenciales)

# 4. Instalar dependencias
cd backend
npm install

# 5. Crear tablas
npm run db:reset

# 6. Crear usuario de prueba
npm run create-test-user

# 7. Arrancar servidor
npm run dev

# 8. En otra terminal, ejecutar tests
npm run test:api

# 9. Ver resultado: 54/54 tests passing ‚úÖ
```

**Tiempo total estimado:** 10-15 minutos

---

## üìñ Documentaci√≥n Adicional

- **API_PAGOS.md** - Documentaci√≥n completa del m√≥dulo de Pagos
- **API_NOTIFICACIONES.md** - Documentaci√≥n completa del m√≥dulo de Notificaciones
- **API_SUBGRUPOS.md** - Documentaci√≥n del m√≥dulo de Subgrupos
- **API_ALOJAMIENTOS.md** - Documentaci√≥n del m√≥dulo de Alojamientos
- **API_MIEMBROS.md** - Documentaci√≥n del m√≥dulo de Miembros
- **API_FRANJAS.md** - Documentaci√≥n del m√≥dulo de Franjas
- **PROGRESO_DESARROLLO.md** - Estado general del proyecto

---

## üÜò Soporte

Si tienes problemas:

1. **Lee este archivo completo** - La mayor√≠a de problemas est√°n resueltos aqu√≠
2. **Revisa los logs** - El servidor muestra mensajes detallados de errores
3. **Verifica las variables de entorno** - Muchos errores vienen de `.env` mal configurado
4. **Prueba el health check** - Si falla, el problema es b√°sico de servidor
5. **Revisa la conexi√≥n a PostgreSQL** - Prueba conectarte manualmente

---

## ‚úÖ Checklist de Verificaci√≥n

Marca los items cuando los completes:

- [ ] Node.js v18+ instalado
- [ ] PostgreSQL 14+ instalado
- [ ] Base de datos `plan_viaje_dev` creada
- [ ] Archivo `.env` configurado con credenciales correctas
- [ ] Dependencias instaladas (`npm install`)
- [ ] Tablas creadas (`npm run db:reset`)
- [ ] Usuario de prueba creado (`npm run create-test-user`)
- [ ] Servidor corriendo (`npm run dev`)
- [ ] Health check responde correctamente
- [ ] Login funciona con test@example.com
- [ ] Tests automatizados pasan 54/54 ‚úÖ

---

## üéâ ¬°Listo!

Si completaste todos los pasos y el servidor est√° corriendo con los tests en verde, **¬°felicitaciones!**

El backend est√° completamente funcional y listo para:
- Desarrollo de frontend
- Integraci√≥n con cliente m√≥vil
- Testing de endpoints
- Agregar nuevas funcionalidades

**El proyecto Plan Viaje Backend est√° 100% operativo** üöÄ

---

**√öltima actualizaci√≥n:** Octubre 2025
**Versi√≥n:** 1.0
**M√≥dulos:** 11/11 completados
**Tests:** 54/54 pasando ‚úÖ
